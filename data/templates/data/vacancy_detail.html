{% extends "main/base.html" %}

{% block title %}{{ vacancy.title }} — Postman{% endblock %}

{% block content %}
<h1>{{ vacancy.title }}</h1>
<p><strong>Описание:</strong></p>
<p>{{ vacancy.description }}</p>

<hr>
<h5>Кандидаты на вакансию:</h5>
<ul class="candidates-list" id="cand-list">
  {% for candidate in vacancy.candidates.all %}
    <li>
      <label>
        <input type="checkbox" name="candidates" value="{{ candidate.id }}">
        <a href="{% url 'candidate_detail' candidate.id %}" class="btn btn-sm btn-outline-success">
          {{ candidate.firstname }} {{ candidate.surname }} —
          <span class="status">{{ candidate.status }}</span>
        </a>
      </label>
    </li>
  {% empty %}
    <li><p>Пока нет кандидатов.</p></li>
  {% endfor %}
</ul>

<hr>
<h5>Шаблоны писем:</h5>
<select name="template_id" id="template-select" class="form-select">
  {% for template in vacancy.templates.all %}
    <option value="{{ template.id }}">{{ template.title }}</option>
  {% empty %}
    <option disabled>Пока нет прикрепленных писем</option>
  {% endfor %}
</select>

<button id="send-btn"
        class="btn btn-primary"
        data-url="{% url 'send_vacancy_emails' vacancy.id %}">
  Отправить письма кандидатам
</button>

<a href="{% url 'vacancy_edit' vacancy.id %}" class="btn btn-outline-primary">Редактировать</a>
<a href="{% url 'vacancies' %}" class="btn btn-secondary ms-2">Назад к списку</a>

<form action="{% url 'vacancy_delete' vacancy.id %}" method="post" style="display:inline;">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger" onclick="return confirm('Удалить вакансию?')">Удалить</button>

<div id="flash" class="alert" style="display:none;margin-top:10px;"></div>

<script>
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

function showFlash(kind, text) {
  const el = document.getElementById('flash');
  el.className = 'alert ' + (kind === 'ok' ? 'alert-success' : 'alert-danger');
  el.textContent = text;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 4000);
}

document.getElementById('send-btn').addEventListener('click', async (e) => {
  e.preventDefault();

  const url = e.currentTarget.dataset.url;
  const csrftoken = getCookie('csrftoken');

  // Собираем выбранных кандидатов и шаблон
  const candidates = Array.from(document.querySelectorAll('input[name="candidates"]:checked'))
                         .map(el => el.value);
  const templateId = document.getElementById('template-select').value;

  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin',
      body: JSON.stringify({
        candidates: candidates,
        template_id: templateId
      })
    });

    if (resp.redirected) {
      showFlash('err', 'Требуется вход в систему. Перезайдите и попробуйте снова.');
      return;
    }

    if (!resp.ok) {
      const text = await resp.text();
      throw new Error(`HTTP ${resp.status}. ${text.slice(0, 200)}`);
    }

    const ct = resp.headers.get('content-type') || '';

    if (ct.includes('application/json')) {
      const data = await resp.json();

      if (data.success) {
        showFlash('ok', data.message || 'Готово');
        document.querySelectorAll('#cand-list .status').forEach(el => {
          el.textContent = 'Письмо отправлено';
        });
      } else {
        showFlash('err', data.message || 'Ошибка');
      }
    } else {
      const text = await resp.text();
      throw new Error(`Ожидался JSON, но пришёл ${ct || 'неизвестный тип'}: ${text.slice(0, 200)}`);
    }
  } catch (err) {
    showFlash('err', 'Ошибка: ' + err.message);
    console.error(err);
  }
});
</script>

</form>
{% endblock %}